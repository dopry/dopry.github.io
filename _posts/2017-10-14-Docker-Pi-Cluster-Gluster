published: false 
---
# Home Automation on Raspberry Pi 3 Cluster using Docker & Gluster

Home Automation has become a bit of a hobby. I've built myself a little faul tolerant cluster for running my home automation, and this is the story of how. 

## Parts

* 1 x Smartthings Hub
* 3 x Raspberry Pi 3 B
* 3 x 64Gb Sandisk Extreme Pro Microsd 


## OS Installation
Raspbian
* ssh
   
* hosts 

  Sticking with out docker theme
  * pier1
  * pier2 
  * pier3

## GlusterFS

We need a file system so containers around bound to the volumes where the data resides. GlusterFS provides and easy way to map block storage across all our hosts that we can easily mount into our containers. 

```
# install glusterfs-server on all of the hosts.
sudo apt-get install glusterfs-server

# create a volume replicated across all hosts. 
# use force since we only have one FS on our hosts.
sudo gluster volume create data replica 3 transport tcp pier1:/srv/data pier2:/srv/data pier3:/srv/data force
```

## Docker Installation
We want to setup our docker cluster. 
```
sudo apt-get install docker
docker swarm init
ssh pi@pier2 docker swarm join
ssh pi@pier3 docker swarm join
```

##  MQTT Broker
docker service create --name mosca --publish 1883:1883 --mount type=volume,src=/srv/data/mosca,dst=/db matteocollina/mosca


## Smartthings MQTT Bridge
docker service create --name smartthings-mqtt-bridge --mount type=volume,src=/srv/data/mqtt-bridge,dst=config --publish 8080:8080 stjohnjohnson/smartthings-mqtt-bridge
